---
title: "github.com/openpharma"
output: 
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bootswatch: minty
    orientation: rows
    social: menu
    source_code: https://github.com/openpharma/openpharma.github.io
    navbar:
      - { title: "Github", href: "https://github.com/openpharma/", align: right, icon: github}
---

```{r, include=FALSE}
library(flexdashboard)
library(ggplot2)

library(dplyr)
library(lubridate)
library(glue)
library(tidyr)
library(fontawesome) # devtools::install_github("rstudio/fontawesome")
library(plotly)

library(purrr)
library(dm)
library(DiagrammeR)



thematic::thematic_rmd(
  font = "auto",
  # To get the dark bg on the geom_raster()
  sequential = thematic::sequential_gradient(fg_low = FALSE, fg_weight = 0, bg_weight = 1)
)
theme_set(theme_bw(base_size = 20))
```

```{r getdata}
library(readr)
  commits <- read_rds("scratch/commits.rds")
  people <- read_rds("scratch/people.rds")
  repos <- read_rds("scratch/repos.rds")
  help <- read_rds("scratch/help.rds")
```


Organization
===================================== 

Value Boxes {data-width=200}
-------------------------------------

### Primary

```{r}
valueBox(n_distinct(repos$repo), caption = "Total repos", icon = "fa-github")
```

### Commits

```{r}
valueBox(nrow(commits), caption = "Commits", color = "success", icon = "fa-code-branch")
```

### People

```{r}
valueBox(
  n_distinct(people$author), 
  caption = "People", color = "success", icon = "fa-users")
```

### Intro issues

```{r}
valueBox(
  help  %>% nrow(), 
  caption = "Open issues needing help", color = "warning", icon = "fa-question")
```

### Companies

```{r}
valueBox(
  n_distinct(people$company), 
  caption = "Unique employers", color = "success", icon = "fa-building")
```

Value Boxes {data-width=200}
-------------------------------------


### 

```{r}
lookback <- 30*3
lookback_char <- "3 months"

valueBox(
  commits %>%
    filter(date > Sys.Date() - lookback) %>%
    pull(full_name) %>% n_distinct(),
  caption = glue("Repos active | Last {lookback_char}"), 
  color = "info", icon = "fa-chart-line"
  )
```

### 

```{r}
valueBox(
  commits %>%
    filter(date > Sys.Date() - lookback) %>%
    nrow(),
  caption = glue("Commits | Last {lookback_char}"),
  color = "info", icon = "glyphicon-time")
```

### 

```{r}
valueBox(
  commits %>%
    filter(date > Sys.Date() - lookback) %>%
    pull(author) %>% n_distinct(),
  caption = glue("People active | Last {lookback_char}"), 
  color = "info", icon = "glyphicon-time")
```

### 

```{r}
valueBox(
  repos %>% filter(lang == "python") %>% nrow(), 
  caption = "Python libraries", color = "info",
  icon = "fab fa-python"
)
```

### 

```{r}
valueBox(
  repos %>% filter(lang == "r") %>% nrow(), 
  caption = "R packages", color = "info",
  icon = "fab fa-r-project"
)
```

    
Tables {.tabset}
-------------------------------------

### Repositories
    
```{r}
hlp_repo_details <- function(x){
  DT::datatable(
      x %>% ungroup %>%
          mutate(
            `Last updated` = as.Date(gh_updated),
            ) %>%
          arrange(desc(`Last updated`)) %>%
          select(
              Repo = pretty_repo,
              Description = imputed_description,
              `Type` = lang,
              `Last updated`,
              `Contributor overlap` = similar
          ), 
      rownames = FALSE,
      escape = FALSE,
      fillContainer = FALSE)  
}

hlp_repo_details(repos)
```

### Help needed
    
```{r}

  DT::datatable(
      help %>% ungroup %>%
          arrange(desc(updated)) %>%
          select(
              Repo = full_name,
              Link = pretty_url,
              Created = created,
              Comments = comments,
              Updated = updated,
              Title = title,
              Description = body
              
          ), 
      rownames = FALSE,
      escape = FALSE,
      fillContainer = FALSE)  

```

### People
    
```{r, echo = FALSE}
DT::datatable(
  people %>%
    mutate(my = format(last_active, "%Y-%m")) %>% 
    group_by(my) %>% mutate(month_commits = sum(commits)) %>% ungroup %>%
    mutate(
      last_active = Sys.Date() - last_active,
      contributor = as.character(glue(
        '<img src="{avatar}" alt="" height="30" width = "30"> {name} (<a href="https://github.com/{author}">{author}</a>)'
        )),
      Blog = case_when(
        blog == "" ~ "",
        TRUE ~ as.character(glue('<a href="{blog}">link</a>'))
        ),
      Name = glue("{name} ({author})")
      ) %>%
    arrange(desc(my),desc(month_commits), desc(contributed_to), desc(commits)) %>%
    select(
      `Name (GH handle)` = contributor,
      Repos = contributed_to,
      `Repo list` = repo_list,
      `Commits` = commits,
      `Days since active` = last_active,
      Company = company,
      Location = location,
      Blog
      ) , 
    escape = FALSE,
    rownames = FALSE,
    fillContainer = FALSE)
```

### Health
    
```{r}
# kaplan mier estimate?


repos %>%
  # tidy title
  select(
    Repo = pretty_repo,
    Health,
    Commits,
    Contributors,
    `Days repo inactive`,
    `Median days open for current issues`,
    `Median days without comments on open issues`,
    `Median days to close issue`,
    `Change in frequency of commits`,
    `Change in active contributors`
  ) %>%
  arrange(
    desc(Health)
  ) %>%
  # table it
  DT::datatable(
    escape = FALSE,
    rownames = FALSE,
    fillContainer = FALSE
    )
```

### Growth

```{r}
### People activity over time
plot <- commits %>%
  mutate(
    month = format(date, "%m"), 
    year = format(date, "%Y"),
    year_mon = as.Date(glue("{year}-{month}-01"))
    ) %>%
  group_by(year_mon) %>%
  summarise(
    Repos = n_distinct(full_name),
    People = n_distinct(author)
  ) %>%
  filter(year_mon >= as.Date("2020-01-01")) %>%
  pivot_longer(
    !year_mon,
    names_to = "Active by month",
    values_to = "Value"
  ) %>%
  # remove last 
  group_by(`Active by month`) %>%
  arrange(year_mon) %>%
  slice(1:(n() - 1)) %>%
  ggplot(
    aes(
      year_mon, 
      Value, 
      group = `Active by month`,
      colour = `Active by month`
    )
  ) +
  geom_line() +
  geom_point() +
  labs(
    title = "Active repos and people defined by monthly commit activity",
    x = "Monthly",
    y = "Active"
  ) + theme(legend.title = element_blank())

ggplotly(plot)
```

### Growth - with denominator

```{r}
range <- commits %>%
  mutate(
    month = format(date, "%m"), 
    year = format(date, "%Y"),
    year_mon = as.Date(glue("{year}-{month}-01"))
  ) %>%
  summarise(
    min = min(year_mon), max = max(year_mon)
  )

### People activity over time
plot <- commits %>%
  mutate(
    month = format(date, "%m"), 
    year = format(date, "%Y"),
    year_mon = as.Date(glue("{year}-{month}-01"))
    ) %>%
  group_by(year_mon) %>%
  summarise(
    Repos = n_distinct(full_name),
    People = n_distinct(author)
  ) %>%
  left_join(
    tibble(
  year_mon = seq.Date(min(range$min), max(range$max), by=1)
  ) %>%
  left_join(
    commits %>%
      mutate(
        month = format(date, "%m"), 
        year = format(date, "%Y"),
        year_mon = as.Date(glue("{year}-{month}-01"))
      ) %>%
      group_by(full_name) %>% 
      arrange(year_mon) %>% slice(1) %>% 
      # check one per date!
      group_by(year_mon) %>% summarise(total = n()),
    by = "year_mon"
  ) %>%
  mutate(
    total = case_when(
      is.na(total) ~ as.integer(0),
      TRUE ~ total
    ),
    tracked_repos = cumsum(total)
  ) %>%
  select(year_mon, `Repo's tracked` = tracked_repos),
    by = "year_mon"
  ) %>%
  filter(year_mon >= as.Date("2020-01-01")) %>%
  pivot_longer(
    !year_mon,
    names_to = "Active by month",
    values_to = "Value"
  ) %>%
  # remove last 
  group_by(`Active by month`) %>%
  arrange(year_mon) %>%
  slice(1:(n() - 1)) %>%
  ggplot(
    aes(
      year_mon, 
      Value, 
      group = `Active by month`,
      colour = `Active by month`
    )
  ) +
  geom_line() +
  geom_point() +
  labs(
    title = "Active repos and people defined by monthly commit activity",
    x = "Monthly",
    y = "Active"
  ) + theme(legend.title = element_blank())

ggplotly(plot)
```


Manifesto
=====================================     
   
Column 
-------------------------------------

### Manifesto

The objective of the Github [organisation github.com/openpharm](https://github.com/openpharma) (openpharma) is to provide a neutral home for open source software that is not tied to one company or institution. This Github organization is managed under the following principals:

Hosting repositories in a neutral space:

* openpharma allows repositories housed within it to set their own governance model
* openpharma is open to any project related to the Pharma industry
* openpharma makes no assumptions on what packages are part of an ‘ideal’ workflow
* a preference is always placed on opensource from day 1, but openpharma will also host packages in private repos on request
* [at launch, Roche has admin status for the organization] openpharma will work towards a governance model that is inclusive and builds trust in those contributing to packages (e.g. use a more formalized consortia like the pharmaverse to provide governance of the Github organization)
* openpharma is open to collaborating with relevant organizations like PHUSE, R Consortium, PSI and the pharmaverse – but  openpharma will remain an open host to share projects and provide a platform for repositories looking for a neutral host. 
* openpharma will not hold any IP or copyright of associated projects, it will not be a platform for discussion or host initiatives, and it will not release opinions or standards on which repositories form part of an ideal workflow.

Promoting collaboration on projects:

* openpharma will aim to build an inclusive list of collaborative projects hosted on github.com that goes beyond those physically hosted in github.com/openpharma.
* openpharma will surface these projects to encourage collaboration (e.g. provide a front end like https://insights.lfx.linuxfoundation.org/projects). As a starter, a proof of concept
has been made (this site)


### Links

- R/Pharma conference: [rinpharma.com](https://rinpharma.com/)
- R Consortium: [r-consortium.org](https://www.r-consortium.org/)
- Get your R project funded!: [ISC](https://www.r-consortium.org/projects/call-for-proposals)

Data
=====================================    
   
Row 
-------------------------------------

### Details on the data pull

The data for this site builds daily. You can access the latest metadata via the 
links on this page. See the Snakefile for an example of the build
process

The code that generates this data is in the repo
[openpharma/openpharma.github.io](https://github.com/openpharma/openpharma.github.io).

Right now the data is not stable - as it is planned to be used in the 
upcoming pharmaverse.org website. Please reach out on the repo if you want to 
use this data, or have ideas to improve / standardise it.

<svg width="493pt" height="357pt"
 viewBox="0.00 0.00 493.07 356.63" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 352.6306)">
<title>snakemake_dag</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-352.6306 489.0682,-352.6306 489.0682,4 -4,4"/>
<!-- 1 -->
<g id="node1" class="node">
<title>1</title>
<path fill="none" stroke="#56d89a" stroke-width="2" d="M83.519,-214.603C83.519,-214.603 12.16,-214.603 12.16,-214.603 6.16,-214.603 .16,-208.603 .16,-202.603 .16,-202.603 .16,-190.603 .16,-190.603 .16,-184.603 6.16,-178.603 12.16,-178.603 12.16,-178.603 83.519,-178.603 83.519,-178.603 89.519,-178.603 95.519,-184.603 95.519,-190.603 95.519,-190.603 95.519,-202.603 95.519,-202.603 95.519,-208.603 89.519,-214.603 83.519,-214.603"/>
<text text-anchor="middle" x="47.8395" y="-193.603" font-family="sans" font-size="10.00" fill="#000000">Generate dashboard</text>
</g>
<!-- 2 -->
<g id="node2" class="node">
<title>2</title>
<path fill="none" stroke="#56d8d8" stroke-width="2" d="M364.3087,-232.1804C364.3087,-232.1804 326.8017,-232.1804 326.8017,-232.1804 320.8017,-232.1804 314.8017,-226.1804 314.8017,-220.1804 314.8017,-220.1804 314.8017,-208.1804 314.8017,-208.1804 314.8017,-202.1804 320.8017,-196.1804 326.8017,-196.1804 326.8017,-196.1804 364.3087,-196.1804 364.3087,-196.1804 370.3087,-196.1804 376.3087,-202.1804 376.3087,-208.1804 376.3087,-208.1804 376.3087,-220.1804 376.3087,-220.1804 376.3087,-226.1804 370.3087,-232.1804 364.3087,-232.1804"/>
<text text-anchor="middle" x="345.5552" y="-211.1804" font-family="sans" font-size="10.00" fill="#000000">Merge data</text>
</g>
<!-- 2&#45;&gt;1 -->
<g id="edge1" class="edge">
<title>2&#45;&gt;1</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M314.8157,-212.3655C265.63,-209.4615 168.4259,-203.7225 105.868,-200.029"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="105.9455,-196.5276 95.7566,-199.432 105.5329,-203.5154 105.9455,-196.5276"/>
</g>
<!-- 3 -->
<g id="node3" class="node">
<title>3</title>
<path fill="none" stroke="#97d856" stroke-width="2" d="M374.6819,-36C374.6819,-36 339.5938,-36 339.5938,-36 333.5938,-36 327.5938,-30 327.5938,-24 327.5938,-24 327.5938,-12 327.5938,-12 327.5938,-6 333.5938,0 339.5938,0 339.5938,0 374.6819,0 374.6819,0 380.6819,0 386.6819,-6 386.6819,-12 386.6819,-12 386.6819,-24 386.6819,-24 386.6819,-30 380.6819,-36 374.6819,-36"/>
<text text-anchor="middle" x="357.1379" y="-15" font-family="sans" font-size="10.00" fill="#000000">Read yaml</text>
</g>
<!-- 3&#45;&gt;2 -->
<g id="edge2" class="edge">
<title>3&#45;&gt;2</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M356.0689,-36.1045C354.0434,-70.4119 349.6331,-145.1109 347.2181,-186.016"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="343.7171,-185.9306 346.6215,-196.1196 350.7049,-186.3433 343.7171,-185.9306"/>
</g>
<!-- 4 -->
<g id="node4" class="node">
<title>4</title>
<path fill="none" stroke="#d89556" stroke-width="2" d="M473.2002,-139.8815C473.2002,-139.8815 425.6732,-139.8815 425.6732,-139.8815 419.6732,-139.8815 413.6732,-133.8815 413.6732,-127.8815 413.6732,-127.8815 413.6732,-115.8815 413.6732,-115.8815 413.6732,-109.8815 419.6732,-103.8815 425.6732,-103.8815 425.6732,-103.8815 473.2002,-103.8815 473.2002,-103.8815 479.2002,-103.8815 485.2002,-109.8815 485.2002,-115.8815 485.2002,-115.8815 485.2002,-127.8815 485.2002,-127.8815 485.2002,-133.8815 479.2002,-139.8815 473.2002,-139.8815"/>
<text text-anchor="middle" x="449.4367" y="-118.8815" font-family="sans" font-size="10.00" fill="#000000">Scrape github</text>
</g>
<!-- 3&#45;&gt;4 -->
<g id="edge6" class="edge">
<title>3&#45;&gt;4</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M373.2151,-36.0948C387.9479,-52.6765 409.9232,-77.4094 426.498,-96.0642"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="423.9755,-98.4947 433.234,-103.6455 429.2084,-93.8453 423.9755,-98.4947"/>
</g>
<!-- 5 -->
<g id="node5" class="node">
<title>5</title>
<path fill="none" stroke="#d85656" stroke-width="2" d="M282.6051,-128.2989C282.6051,-128.2989 223.9076,-128.2989 223.9076,-128.2989 217.9076,-128.2989 211.9076,-122.2989 211.9076,-116.2989 211.9076,-116.2989 211.9076,-104.2989 211.9076,-104.2989 211.9076,-98.2989 217.9076,-92.2989 223.9076,-92.2989 223.9076,-92.2989 282.6051,-92.2989 282.6051,-92.2989 288.6051,-92.2989 294.6051,-98.2989 294.6051,-104.2989 294.6051,-104.2989 294.6051,-116.2989 294.6051,-116.2989 294.6051,-122.2989 288.6051,-128.2989 282.6051,-128.2989"/>
<text text-anchor="middle" x="253.2564" y="-107.2989" font-family="sans" font-size="10.00" fill="#000000">Scrape metacran</text>
</g>
<!-- 3&#45;&gt;5 -->
<g id="edge7" class="edge">
<title>3&#45;&gt;5</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M336.6142,-36.2353C320.8211,-50.2675 298.8208,-69.8148 281.3873,-85.3045"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="278.8882,-82.843 273.7374,-92.1014 283.5376,-88.0758 278.8882,-82.843"/>
</g>
<!-- 4&#45;&gt;2 -->
<g id="edge3" class="edge">
<title>4&#45;&gt;2</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M428.9131,-140.1168C413.12,-154.149 391.1196,-173.6963 373.6861,-189.186"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="371.187,-186.7245 366.0362,-195.9829 375.8365,-191.9573 371.187,-186.7245"/>
</g>
<!-- 5&#45;&gt;2 -->
<g id="edge4" class="edge">
<title>5&#45;&gt;2</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M269.3336,-128.3936C284.0664,-144.9753 306.0417,-169.7083 322.6165,-188.3631"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="320.094,-190.7935 329.3525,-195.9444 325.3269,-186.1441 320.094,-190.7935"/>
</g>
<!-- 6 -->
<g id="node6" class="node">
<title>6</title>
<path fill="none" stroke="#569ad8" stroke-width="2" d="M371.4864,-348.6306C371.4864,-348.6306 305.8734,-348.6306 305.8734,-348.6306 299.8734,-348.6306 293.8734,-342.6306 293.8734,-336.6306 293.8734,-336.6306 293.8734,-324.6306 293.8734,-324.6306 293.8734,-318.6306 299.8734,-312.6306 305.8734,-312.6306 305.8734,-312.6306 371.4864,-312.6306 371.4864,-312.6306 377.4864,-312.6306 383.4864,-318.6306 383.4864,-324.6306 383.4864,-324.6306 383.4864,-336.6306 383.4864,-336.6306 383.4864,-342.6306 377.4864,-348.6306 371.4864,-348.6306"/>
<text text-anchor="middle" x="338.6799" y="-327.6306" font-family="sans" font-size="10.00" fill="#000000">Get historical data</text>
</g>
<!-- 6&#45;&gt;2 -->
<g id="edge5" class="edge">
<title>6&#45;&gt;2</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M339.7542,-312.4352C340.8642,-293.6346 342.6113,-264.0418 343.8984,-242.2421"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="347.3929,-242.4369 344.4885,-232.2479 340.4051,-242.0242 347.3929,-242.4369"/>
</g>
</g>
</svg>

These files contains *all* the data up to today, and was pulled ~ `r Sys.time()`.

- Latest repo data ([csv](http://openpharma.s3-website.us-east-2.amazonaws.com/repos.csv))

- Latest people data ([csv](http://openpharma.s3-website.us-east-2.amazonaws.com/people.csv))

- Latest who needs help data ([csv](http://openpharma.s3-website.us-east-2.amazonaws.com/help.csv))

- Latest commits data ([csv](http://openpharma.s3-website.us-east-2.amazonaws.com/commits.csv))

### Available data



```{r}
dm(repos, people, help, commits) %>%
  dm_add_pk(table = repos, columns = full_name) %>%
  dm_add_pk(table = people, columns = author) %>%
  dm_add_pk(table = help, columns = full_name) %>%
  dm_add_pk(table = commits, columns = full_name) %>%
  dm_add_fk(table = repos, columns = full_name, ref_table = commits) %>%
  dm_add_fk(table = repos, columns = full_name, ref_table = help) %>%
  dm_draw(
    view_type = "all", 
    column_types = TRUE, rankdir = "TB")
```

<!-- ### Links to all raw data -->

<!-- ```{r} -->
<!-- readRDS("scratch/s3_contents.rds") %>% knitr::kable() -->
<!-- ``` -->
