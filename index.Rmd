---
title: "github.com/openpharma"
output: 
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bootswatch: minty
    orientation: rows
    social: menu
    source_code: https://github.com/openpharma/openpharma.github.io
    navbar:
      - { title: "Github", href: "https://github.com/openpharma/", align: right, icon: github}
---

```{r, include=FALSE}
library(flexdashboard)
library(ggplot2)

library(dplyr)
library(lubridate)
library(glue)
library(tidyr)
library(fontawesome) # devtools::install_github("rstudio/fontawesome")
library(plotly)

library(purrr)
library(dm)
library(DiagrammeR)



thematic::thematic_rmd(
  font = "auto",
  # To get the dark bg on the geom_raster()
  sequential = thematic::sequential_gradient(fg_low = FALSE, fg_weight = 0, bg_weight = 1)
)
theme_set(theme_bw(base_size = 20))
```

```{r getdata}
library(readr)
  commits <- read_rds("scratch/commits.rds")
  people <- read_rds("scratch/people.rds")
  repos <- read_rds("scratch/repos.rds")
  help <- read_rds("scratch/help.rds")
```


Organization
===================================== 

Value Boxes {data-width=200}
-------------------------------------

### Primary

```{r}
valueBox(n_distinct(repos$repo), caption = "Total repos", icon = "fa-github")
```

### Commits

```{r}
valueBox(nrow(commits), caption = "Commits", color = "success", icon = "fa-code-branch")
```

### People

```{r}
valueBox(
  n_distinct(people$author), 
  caption = "People", color = "success", icon = "fa-users")
```

### Intro issues

```{r}
valueBox(
  help  %>% nrow(), 
  caption = "Open issues needing help", color = "warning", icon = "fa-question")
```

### Companies

```{r}
valueBox(
  n_distinct(people$company), 
  caption = "Unique employers", color = "success", icon = "fa-building")
```

Value Boxes {data-width=200}
-------------------------------------


### 

```{r}
lookback <- 30*3
lookback_char <- "3 months"

valueBox(
  commits %>%
    filter(date > Sys.Date() - lookback) %>%
    pull(full_name) %>% n_distinct(),
  caption = glue("Repos active | Last {lookback_char}"), 
  color = "info", icon = "fa-chart-line"
  )
```

### 

```{r}
valueBox(
  commits %>%
    filter(date > Sys.Date() - lookback) %>%
    nrow(),
  caption = glue("Commits | Last {lookback_char}"),
  color = "info", icon = "glyphicon-time")
```

### 

```{r}
valueBox(
  commits %>%
    filter(date > Sys.Date() - lookback) %>%
    pull(author) %>% n_distinct(),
  caption = glue("People active | Last {lookback_char}"), 
  color = "info", icon = "glyphicon-time")
```

### 

```{r}
valueBox(
  repos %>% filter(lang == "python") %>% nrow(), 
  caption = "Python libraries", color = "info",
  icon = "fab fa-python"
)
```

### 

```{r}
valueBox(
  repos %>% filter(lang == "r") %>% nrow(), 
  caption = "R packages", color = "info",
  icon = "fab fa-r-project"
)
```

    
Tables {.tabset}
-------------------------------------

### Repositories
    
```{r}
hlp_repo_details <- function(x){
  DT::datatable(
      x %>% ungroup %>%
          mutate(
            `Last updated` = as.Date(gh_updated),
            ) %>%
          arrange(desc(`Last updated`)) %>%
          select(
              Repo = pretty_repo,
              Description = imputed_description,
              `Type` = lang,
              `Last updated`,
              `Contributor overlap` = similar
          ), 
      rownames = FALSE,
      escape = FALSE,
      fillContainer = FALSE)  
}

hlp_repo_details(repos)
```

### Help needed
    
```{r}

  DT::datatable(
      help %>% ungroup %>%
          arrange(desc(updated)) %>%
          select(
              Repo = full_name,
              Link = pretty_url,
              Created = created,
              Comments = comments,
              Updated = updated,
              Title = title,
              Description = body
              
          ), 
      rownames = FALSE,
      escape = FALSE,
      fillContainer = FALSE)  

```

### People
    
```{r, echo = FALSE}
DT::datatable(
  people %>%
    mutate(my = format(last_active, "%Y-%m")) %>% 
    group_by(my) %>% mutate(month_commits = sum(commits)) %>% ungroup %>%
    mutate(
      last_active = Sys.Date() - last_active,
      contributor = as.character(glue(
        '<img src="{avatar}" alt="" height="30" width = "30"> {name} (<a href="https://github.com/{author}">{author}</a>)'
        )),
      Blog = case_when(
        blog == "" ~ "",
        TRUE ~ as.character(glue('<a href="{blog}">link</a>'))
        ),
      Name = glue("{name} ({author})")
      ) %>%
    arrange(desc(my),desc(month_commits), desc(contributed_to), desc(commits)) %>%
    select(
      `Name (GH handle)` = contributor,
      Repos = contributed_to,
      `Repo list` = repo_list,
      `Commits` = commits,
      `Days since active` = last_active,
      Company = company,
      Location = location,
      Blog
      ) , 
    escape = FALSE,
    rownames = FALSE,
    fillContainer = FALSE)
```

### Health
    
```{r}
# kaplan mier estimate?


repos %>%
  # tidy title
  select(
    Repo = pretty_repo,
    Health,
    Commits,
    Contributors,
    `Days repo inactive`,
    `Median days open for current issues`,
    `Median days without comments on open issues`,
    `Median days to close issue`,
    `Change in frequency of commits`,
    `Change in active contributors`
  ) %>%
  arrange(
    desc(Health)
  ) %>%
  # table it
  DT::datatable(
    escape = FALSE,
    rownames = FALSE,
    fillContainer = FALSE
    )
```

### Growth

```{r}
### People activity over time
plot <- commits %>%
  mutate(
    month = format(date, "%m"), 
    year = format(date, "%Y"),
    year_mon = as.Date(glue("{year}-{month}-01"))
    ) %>%
  group_by(year_mon) %>%
  summarise(
    Repos = n_distinct(full_name),
    People = n_distinct(author)
  ) %>%
  filter(year_mon >= as.Date("2020-01-01")) %>%
  pivot_longer(
    !year_mon,
    names_to = "Active by month",
    values_to = "Value"
  ) %>%
  # remove last 
  group_by(`Active by month`) %>%
  arrange(year_mon) %>%
  slice(1:(n() - 1)) %>%
  ggplot(
    aes(
      year_mon, 
      Value, 
      group = `Active by month`,
      colour = `Active by month`
    )
  ) +
  geom_line() +
  geom_point() +
  labs(
    title = "Active repos and people defined by monthly commit activity",
    x = "Monthly",
    y = "Active"
  ) + theme(legend.title = element_blank())

ggplotly(plot)
```

### Growth - with denominator

```{r}
range <- commits %>%
  mutate(
    month = format(date, "%m"), 
    year = format(date, "%Y"),
    year_mon = as.Date(glue("{year}-{month}-01"))
  ) %>%
  summarise(
    min = min(year_mon), max = max(year_mon)
  )

### People activity over time
plot <- commits %>%
  mutate(
    month = format(date, "%m"), 
    year = format(date, "%Y"),
    year_mon = as.Date(glue("{year}-{month}-01"))
    ) %>%
  group_by(year_mon) %>%
  summarise(
    Repos = n_distinct(full_name),
    People = n_distinct(author)
  ) %>%
  left_join(
    tibble(
  year_mon = seq.Date(min(range$min), max(range$max), by=1)
  ) %>%
  left_join(
    commits %>%
      mutate(
        month = format(date, "%m"), 
        year = format(date, "%Y"),
        year_mon = as.Date(glue("{year}-{month}-01"))
      ) %>%
      group_by(full_name) %>% 
      arrange(year_mon) %>% slice(1) %>% 
      # check one per date!
      group_by(year_mon) %>% summarise(total = n()),
    by = "year_mon"
  ) %>%
  mutate(
    total = case_when(
      is.na(total) ~ as.integer(0),
      TRUE ~ total
    ),
    tracked_repos = cumsum(total)
  ) %>%
  select(year_mon, `Repo's tracked` = tracked_repos),
    by = "year_mon"
  ) %>%
  filter(year_mon >= as.Date("2020-01-01")) %>%
  pivot_longer(
    !year_mon,
    names_to = "Active by month",
    values_to = "Value"
  ) %>%
  # remove last 
  group_by(`Active by month`) %>%
  arrange(year_mon) %>%
  slice(1:(n() - 1)) %>%
  ggplot(
    aes(
      year_mon, 
      Value, 
      group = `Active by month`,
      colour = `Active by month`
    )
  ) +
  geom_line() +
  geom_point() +
  labs(
    title = "Active repos and people defined by monthly commit activity",
    x = "Monthly",
    y = "Active"
  ) + theme(legend.title = element_blank())

ggplotly(plot)
```


Manifesto
=====================================     
   
Column 
-------------------------------------

### Manifesto

The objective of the Github [organisation github.com/openpharm](https://github.com/openpharma) (openpharma) is to provide a neutral home for open source software that is not tied to one company or institution. This Github organization is managed under the following principals:

Hosting repositories in a neutral space:

* openpharma allows repositories housed within it to set their own governance model
* openpharma is open to any project related to the Pharma industry
* openpharma makes no assumptions on what packages are part of an ‘ideal’ workflow
* a preference is always placed on opensource from day 1, but openpharma will also host packages in private repos on request
* [at launch, Roche has admin status for the organization] openpharma will work towards a governance model that is inclusive and builds trust in those contributing to packages (e.g. use a more formalized consortia like the pharmaverse to provide governance of the Github organization)
* openpharma is open to collaborating with relevant organizations like PHUSE, R Consortium, PSI and the pharmaverse – but  openpharma will remain an open host to share projects and provide a platform for repositories looking for a neutral host. 
* openpharma will not hold any IP or copyright of associated projects, it will not be a platform for discussion or host initiatives, and it will not release opinions or standards on which repositories form part of an ideal workflow.

Promoting collaboration on projects:

* openpharma will aim to build an inclusive list of collaborative projects hosted on github.com that goes beyond those physically hosted in github.com/openpharma.
* openpharma will surface these projects to encourage collaboration (e.g. provide a front end like https://insights.lfx.linuxfoundation.org/projects). As a starter, a proof of concept
has been made (this site)


### Links

- R/Pharma conference: [rinpharma.com](https://rinpharma.com/)
- R Consortium: [r-consortium.org](https://www.r-consortium.org/)
- Get your R project funded!: [ISC](https://www.r-consortium.org/projects/call-for-proposals)

Data
=====================================    
   
Row 
-------------------------------------

### Details on the data pull

The data for this site builds daily. You can access the latest metadata via the 
links on this page. See the Snakefile for an example of the build
process

The code that generates this data is in the repo
[openpharma/openpharma.github.io](https://github.com/openpharma/openpharma.github.io).

Right now the data is not stable - as it is planned to be used in the 
upcoming pharmaverse.org website. Please reach out on the repo if you want to 
use this data, or have ideas to improve / standardise it.

<svg width="404pt" height="279pt"
 viewBox="0.00 0.00 404.36 278.94" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 274.9357)">
<title>snakemake_dag</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-274.9357 400.3576,-274.9357 400.3576,4 -4,4"/>
<!-- 1 -->
<g id="node1" class="node">
<title>1</title>
<path fill="none" stroke="#97d856" stroke-width="2" d="M47.4733,-153.4678C47.4733,-153.4678 11.8417,-153.4678 11.8417,-153.4678 5.8417,-153.4678 -.1583,-147.4678 -.1583,-141.4678 -.1583,-141.4678 -.1583,-129.4678 -.1583,-129.4678 -.1583,-123.4678 5.8417,-117.4678 11.8417,-117.4678 11.8417,-117.4678 47.4733,-117.4678 47.4733,-117.4678 53.4733,-117.4678 59.4733,-123.4678 59.4733,-129.4678 59.4733,-129.4678 59.4733,-141.4678 59.4733,-141.4678 59.4733,-147.4678 53.4733,-153.4678 47.4733,-153.4678"/>
<text text-anchor="middle" x="29.6575" y="-132.4678" font-family="sans" font-size="10.00" fill="#000000">Dashboard</text>
</g>
<!-- 2 -->
<g id="node2" class="node">
<title>2</title>
<path fill="none" stroke="#569ad8" stroke-width="2" d="M146.315,-153.4678C146.315,-153.4678 116.315,-153.4678 116.315,-153.4678 110.315,-153.4678 104.315,-147.4678 104.315,-141.4678 104.315,-141.4678 104.315,-129.4678 104.315,-129.4678 104.315,-123.4678 110.315,-117.4678 116.315,-117.4678 116.315,-117.4678 146.315,-117.4678 146.315,-117.4678 152.315,-117.4678 158.315,-123.4678 158.315,-129.4678 158.315,-129.4678 158.315,-141.4678 158.315,-141.4678 158.315,-147.4678 152.315,-153.4678 146.315,-153.4678"/>
<text text-anchor="middle" x="131.315" y="-132.4678" font-family="sans" font-size="10.00" fill="#000000">Merge</text>
</g>
<!-- 2&#45;&gt;1 -->
<g id="edge1" class="edge">
<title>2&#45;&gt;1</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M104.0727,-135.4678C93.536,-135.4678 81.2618,-135.4678 69.7561,-135.4678"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="69.4777,-131.9679 59.4776,-135.4678 69.4776,-138.9679 69.4777,-131.9679"/>
</g>
<!-- 3 -->
<g id="node3" class="node">
<title>3</title>
<path fill="none" stroke="#d85656" stroke-width="2" d="M231.6604,-270.9357C231.6604,-270.9357 201.6604,-270.9357 201.6604,-270.9357 195.6604,-270.9357 189.6604,-264.9357 189.6604,-258.9357 189.6604,-258.9357 189.6604,-246.9357 189.6604,-246.9357 189.6604,-240.9357 195.6604,-234.9357 201.6604,-234.9357 201.6604,-234.9357 231.6604,-234.9357 231.6604,-234.9357 237.6604,-234.9357 243.6604,-240.9357 243.6604,-246.9357 243.6604,-246.9357 243.6604,-258.9357 243.6604,-258.9357 243.6604,-264.9357 237.6604,-270.9357 231.6604,-270.9357"/>
<text text-anchor="middle" x="216.6604" y="-249.9357" font-family="sans" font-size="10.00" fill="#000000">YAML</text>
</g>
<!-- 3&#45;&gt;2 -->
<g id="edge2" class="edge">
<title>3&#45;&gt;2</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M203.5122,-234.8388C189.395,-215.408 166.8218,-184.3387 150.6746,-162.114"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="153.3282,-159.8118 144.6187,-153.7788 147.6651,-163.9263 153.3282,-159.8118"/>
</g>
<!-- 4 -->
<g id="node4" class="node">
<title>4</title>
<path fill="none" stroke="#d6d856" stroke-width="2" d="M231.6604,-36C231.6604,-36 201.6604,-36 201.6604,-36 195.6604,-36 189.6604,-30 189.6604,-24 189.6604,-24 189.6604,-12 189.6604,-12 189.6604,-6 195.6604,0 201.6604,0 201.6604,0 231.6604,0 231.6604,0 237.6604,0 243.6604,-6 243.6604,-12 243.6604,-12 243.6604,-24 243.6604,-24 243.6604,-30 237.6604,-36 231.6604,-36"/>
<text text-anchor="middle" x="216.6604" y="-15" font-family="sans" font-size="10.00" fill="#000000">Github</text>
</g>
<!-- 3&#45;&gt;4 -->
<g id="edge6" class="edge">
<title>3&#45;&gt;4</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M216.6604,-234.8908C216.6604,-194.2345 216.6604,-95.2127 216.6604,-46.2979"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="220.1605,-46.1064 216.6604,-36.1064 213.1605,-46.1064 220.1605,-46.1064"/>
</g>
<!-- 6 -->
<g id="node6" class="node">
<title>6</title>
<path fill="none" stroke="#56d89a" stroke-width="2" d="M369.7521,-226.0669C369.7521,-226.0669 339.7521,-226.0669 339.7521,-226.0669 333.7521,-226.0669 327.7521,-220.0669 327.7521,-214.0669 327.7521,-214.0669 327.7521,-202.0669 327.7521,-202.0669 327.7521,-196.0669 333.7521,-190.0669 339.7521,-190.0669 339.7521,-190.0669 369.7521,-190.0669 369.7521,-190.0669 375.7521,-190.0669 381.7521,-196.0669 381.7521,-202.0669 381.7521,-202.0669 381.7521,-214.0669 381.7521,-214.0669 381.7521,-220.0669 375.7521,-226.0669 369.7521,-226.0669"/>
<text text-anchor="middle" x="354.7521" y="-205.0669" font-family="sans" font-size="10.00" fill="#000000">Metacran</text>
</g>
<!-- 3&#45;&gt;6 -->
<g id="edge8" class="edge">
<title>3&#45;&gt;6</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M243.9429,-244.0711C265.1261,-237.1882 294.7101,-227.5758 317.982,-220.0143"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="319.0973,-223.3321 327.5263,-216.9131 316.9341,-216.6747 319.0973,-223.3321"/>
</g>
<!-- 4&#45;&gt;2 -->
<g id="edge3" class="edge">
<title>4&#45;&gt;2</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M203.5122,-36.0969C189.395,-55.5276 166.8218,-86.5969 150.6746,-108.8217"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="147.6651,-107.0094 144.6187,-117.1568 153.3282,-111.1239 147.6651,-107.0094"/>
</g>
<!-- 5 -->
<g id="node5" class="node">
<title>5</title>
<path fill="none" stroke="#56d8d8" stroke-width="2" d="M384.4634,-80.8687C384.4634,-80.8687 325.0408,-80.8687 325.0408,-80.8687 319.0408,-80.8687 313.0408,-74.8687 313.0408,-68.8687 313.0408,-68.8687 313.0408,-56.8687 313.0408,-56.8687 313.0408,-50.8687 319.0408,-44.8687 325.0408,-44.8687 325.0408,-44.8687 384.4634,-44.8687 384.4634,-44.8687 390.4634,-44.8687 396.4634,-50.8687 396.4634,-56.8687 396.4634,-56.8687 396.4634,-68.8687 396.4634,-68.8687 396.4634,-74.8687 390.4634,-80.8687 384.4634,-80.8687"/>
<text text-anchor="middle" x="354.7521" y="-59.8687" font-family="sans" font-size="10.00" fill="#000000">Previous S3 data</text>
</g>
<!-- 5&#45;&gt;2 -->
<g id="edge5" class="edge">
<title>5&#45;&gt;2</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M312.9874,-76.4389C271.3011,-89.9836 207.8714,-110.5932 168.0502,-123.5319"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="166.8914,-120.2282 158.4624,-126.6471 169.0545,-126.8856 166.8914,-120.2282"/>
</g>
<!-- 5&#45;&gt;4 -->
<g id="edge7" class="edge">
<title>5&#45;&gt;4</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M312.9453,-49.2849C294.0571,-43.1477 271.9302,-35.9582 253.6539,-30.0199"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="254.5337,-26.6257 243.9416,-26.8642 252.3706,-33.2831 254.5337,-26.6257"/>
</g>
<!-- 6&#45;&gt;2 -->
<g id="edge4" class="edge">
<title>6&#45;&gt;2</title>
<path fill="none" stroke="#c0c0c0" stroke-width="2" d="M327.3543,-199.1649C287.3776,-186.1757 212.9624,-161.9967 168.2053,-147.4542"/>
<polygon fill="#c0c0c0" stroke="#c0c0c0" stroke-width="2" points="169.1792,-144.0906 158.587,-144.3291 167.016,-150.748 169.1792,-144.0906"/>
</g>
</g>
</svg>


These files contains *all* the data up to today, and was pulled ~ `r Sys.time()`.

- Latest repo data ([csv](http://openpharma.s3-website.us-east-2.amazonaws.com/repos.csv), `r format(object.size(repos), units = "Mb")`)

- Latest people data ([csv](http://openpharma.s3-website.us-east-2.amazonaws.com/people.csv), `r format(object.size(people), units = "Mb")`)

- Latest who needs help data ([csv](http://openpharma.s3-website.us-east-2.amazonaws.com/help.csv), `r format(object.size(help), units = "Mb")`)

- Latest commits data ([csv](http://openpharma.s3-website.us-east-2.amazonaws.com/commits.csv), `r format(object.size(commits), units = "Mb")`)

### Available data



```{r}
dm(repos, people, help, commits) %>%
  dm_add_pk(table = repos, columns = full_name) %>%
  dm_add_pk(table = people, columns = author) %>%
  dm_add_pk(table = help, columns = full_name) %>%
  dm_add_pk(table = commits, columns = full_name) %>%
  dm_add_fk(table = repos, columns = full_name, ref_table = commits) %>%
  dm_add_fk(table = repos, columns = full_name, ref_table = help) %>%
  dm_draw(
    view_type = "all", 
    column_types = TRUE, rankdir = "TB")
```

<!-- ### Links to all raw data -->

<!-- ```{r} -->
<!-- readRDS("scratch/s3_contents.rds") %>% knitr::kable() -->
<!-- ``` -->
